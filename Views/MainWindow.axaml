<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ecosystem.ViewModels"
        xmlns:helpers="using:ecosystem.Helpers"
        x:Class="ecosystem.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Ecosystem"
        Width="800"
        Height="600"
        SizeChanged="Window_SizeChanged"
        Loaded="Window_Loaded">

    <DockPanel LastChildFill="True">
        <!-- Controls at bottom -->
        <StackPanel DockPanel.Dock="Bottom"
                    Height="50"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center">
            <Button Command="{Binding StartSimulationCommand}">Start</Button>
            <Button Command="{Binding PauseSimulationCommand}" Margin="5,0">Pause</Button>
            <Button Command="{Binding ResetSimulationCommand}">Reset</Button>
            <Button Command="{Binding ToggleDebugCommand}" Margin="5,0">
                Debug Mode
            </Button>
            <TextBlock Text="{Binding Status}" 
                    VerticalAlignment="Center"
                    Margin="10,0"/>
        </StackPanel>

        <!-- Main simulation area -->
        <Grid>
            <!-- Background -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Rectangle Grid.Row="0" Grid.Column="0" Fill="SandyBrown"/>
                <Rectangle Grid.Row="0" Grid.Column="1" Fill="LightBlue"/>
                <Rectangle Grid.Row="1" Grid.Column="0" Fill="LightGreen"/>
                <Rectangle Grid.Row="1" Grid.Column="1" Fill="SandyBrown"/>
            </Grid>

            <!-- Safe Movement Area Border -->
            <Border BorderBrush="Red" 
                    BorderThickness="2" 
                    Width="{Binding WindowWidth, Converter={StaticResource SafeAreaConverter}}"
                    Height="{Binding WindowHeight, Converter={StaticResource SafeAreaConverter}, ConverterParameter=height}"
                    Margin="{Binding WindowWidth, Converter={StaticResource SafeAreaMarginConverter}}"/>

            <!-- Entity Canvas -->
            <ItemsControl ItemsSource="{Binding EntityViewModels}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas Name="MainCanvas" 
                                Width="{Binding WindowWidth}" 
                                Height="{Binding WindowHeight}"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Canvas>
                            <!-- Sprite Image -->
                            <Image Width="{Binding SpriteSize}"
                                Height="{Binding SpriteSize}"
                                Source="{Binding SpriteBitmap}"
                                IsVisible="{Binding HasSprite}"
                                Canvas.Left="{Binding SpriteCenteredX}"
                                Canvas.Top="{Binding SpriteCenteredY}">
                                <Image.IsVisible>
                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                        <Binding Path="HasSprite"/>
                                        <Binding Path="!$parent[Window].((vm:MainWindowViewModel)DataContext).IsDebugMode"/>
                                    </MultiBinding>
                                </Image.IsVisible>
                                <Image.RenderTransform>
                                    <TransformGroup>
                                        <TranslateTransform Y="-10"/>
                                        <ScaleTransform ScaleX="{Binding MovementDirection}" ScaleY="1"/>
                                    </TransformGroup>
                                </Image.RenderTransform>
                            </Image>

                            <!-- Debug Elements -->
                            <Canvas IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).IsDebugMode}">
                                <!-- Root Circle for Plants -->
                                <Ellipse Width="{Binding ScaledRootRadius}"
                                        Height="{Binding ScaledRootRadius}"
                                        Fill="{Binding Color}"
                                        Opacity="0.2"
                                        IsVisible="{Binding Entity, Converter={x:Static helpers:TypeConverters.IsPlant}}"
                                        Canvas.Left="{Binding CenteredRootX}"
                                        Canvas.Top="{Binding CenteredRootY}"/>

                                <!-- Vision Circle -->
                                <Ellipse Width="{Binding ScaledVisionRadius}"
                                        Height="{Binding ScaledVisionRadius}"
                                        Stroke="{Binding Color}"
                                        StrokeThickness="1"
                                        Fill="{Binding Color}"
                                        Opacity="0.2"
                                        Canvas.Left="{Binding CenteredX}"
                                        Canvas.Top="{Binding CenteredY}"/>

                                <!-- Contact Circle -->
                                <Ellipse Width="{Binding ScaledContactRadius}"
                                        Height="{Binding ScaledContactRadius}"
                                        Stroke="Red"
                                        StrokeThickness="1"
                                        Fill="{Binding Color}"
                                        Canvas.Left="{Binding CenteredContactX}"
                                        Canvas.Top="{Binding CenteredContactY}"/>

                                <!-- Entity Name and Stats -->
                                <TextBlock Text="{Binding Entity.DisplayName}"
                                        FontSize="10"
                                        Canvas.Left="{Binding DisplayX}"
                                        Canvas.Top="{Binding DisplayY}">
                                    <TextBlock.RenderTransform>
                                        <TranslateTransform X="-20" Y="-17"/>
                                    </TextBlock.RenderTransform>
                                </TextBlock>
                                                            
                                <TextBlock Text="{Binding StatsText}"
                                        FontSize="10"
                                        Foreground="Black"
                                        TextAlignment="Center"
                                        Canvas.Left="{Binding DisplayX}"
                                        Canvas.Top="{Binding DisplayY}">
                                    <TextBlock.RenderTransform>
                                        <TranslateTransform X="-30" Y="10"/>
                                    </TextBlock.RenderTransform>
                                </TextBlock>
                            </Canvas>
                        </Canvas>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </DockPanel>
</Window>